{% extends 'base/base.html' %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –ø—ñ–¥–ø–∏—Å–∫–∏ - {{ plan.name }} - Play Vision{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/subscription-checkout.css' %}">
{% endblock %}

{% block content %}
<div class="subscription-checkout-container">
    <div class="container">
        <!-- Breadcrumbs -->
        <nav class="breadcrumbs" aria-label="–•–ª—ñ–±–Ω—ñ –∫—Ä–∏—Ö—Ç–∏">
            <a href="{% url 'subscriptions:pricing' %}">–ü—ñ–¥–ø–∏—Å–∫–∏</a>
            <span class="separator">‚Ä∫</span>
            <span class="current">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è</span>
        </nav>

        <div class="checkout-grid">
            <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ - –§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç–∏ -->
            <div class="checkout-main">
                <h1 class="checkout-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –ø—ñ–¥–ø–∏—Å–∫–∏</h1>

                {% if has_active_subscription %}
                <div class="alert alert-info">
                    <p>–£ –≤–∞—Å –≤–∂–µ —î –∞–∫—Ç–∏–≤–Ω–∞ –ø—ñ–¥–ø–∏—Å–∫–∞ <strong>{{ active_subscription.plan.name }}</strong></p>
                    <p>–ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –Ω–æ–≤–∞ –ø—ñ–¥–ø–∏—Å–∫–∞ –∑–∞–º—ñ–Ω–∏—Ç—å –ø–æ—Ç–æ—á–Ω—É</p>
                </div>
                {% endif %}

                {% if comparison_data.has_purchases %}
                <div class="comparison-block">
                    <h3>üí∞ –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –æ–∫—Ä–µ–º–∏–º–∏ –ø–æ–∫—É–ø–∫–∞–º–∏</h3>
                    <p>–í–∏ –≤–∂–µ –∑–∞–ø–ª–∞—Ç–∏–ª–∏ <strong>{{ comparison_data.total_spent }}‚Ç¥</strong> –∑–∞ {{
                        comparison_data.courses_count }} –∫—É—Ä—Å{% if comparison_data.courses_count > 1 %}–∏{% endif %}</p>
                    <p class="highlight">–ü—ñ–¥–ø–∏—Å–∫–∞ <strong>{{ plan.name }}</strong> –¥–∞—î –¥–æ—Å—Ç—É–ø –¥–æ –≤—Å—å–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –∑–∞
                        <strong>{{ plan.price }}‚Ç¥</strong></p>
                </div>
                {% endif %}

                <!-- –§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç–∏ -->
                <form id="payment-form" method="post" action="{% url 'subscriptions:process_payment' plan.id %}">
                    {% csrf_token %}

                    <!-- –ü—Ä–æ–º–æ–∫–æ–¥ -->
                    <div class="form-section">
                        <h3>–ü—Ä–æ–º–æ–∫–æ–¥</h3>
                        <div class="coupon-input-group">
                            <input type="text" id="coupon-code" name="coupon_code" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥"
                                class="form-input">
                            <button type="button" id="validate-coupon-btn" class="btn btn-secondary">
                                –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏
                            </button>
                        </div>
                        <div id="coupon-message" class="coupon-message"></div>
                    </div>

                    <!-- –°–ø–æ—Å–æ–±–∏ –æ–ø–ª–∞—Ç–∏ -->
                    <div class="form-section">
                        <h3>–°–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏</h3>
                        <div class="payment-methods">
                            {% for method in payment_methods %}
                            <label class="payment-method-option">
                                <input type="radio" name="payment_method" value="{{ method.id }}" {% if forloop.first
                                    %}checked{% endif %}>
                                <span class="payment-method-label">
                                    <span class="payment-icon payment-icon-{{ method.icon }}"></span>
                                    <span class="payment-name">{{ method.name }}</span>
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- –ê–≤—Ç–æ–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è -->
                    <div class="auto-renew-section">
                        <div class="info-box">
                            <p>{{ auto_renew_info.text }}</p>
                            <p class="next-payment">
                                –ù–∞—Å—Ç—É–ø–Ω–µ —Å–ø–∏—Å–∞–Ω–Ω—è: <strong>{{ auto_renew_info.next_payment_date|date:"d.m.Y" }}</strong>
                            </p>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç–∏ -->
                    <button type="submit" class="btn btn-primary btn-large btn-pay">
                        –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –æ–ø–ª–∞—Ç—É {{ plan.price }}‚Ç¥
                    </button>

                    <!-- –£–≥–æ–¥–∞ -->
                    <div class="agreement-text">
                        –ù–∞—Ç–∏—Å–∫–∞—é—á–∏ ¬´–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –æ–ø–ª–∞—Ç—É¬ª, –≤–∏ –ø–æ–≥–æ–¥–∂—É—î—Ç–µ—Å—å –∑
                        <a href="{% url 'core:legal' slug='terms' %}" target="_blank">–£–º–æ–≤–∞–º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è</a> —Ç–∞
                        <a href="{% url 'core:legal' slug='privacy' %}" target="_blank">–ü–æ–ª—ñ—Ç–∏–∫–æ—é –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–æ—Å—Ç—ñ</a>
                    </div>
                </form>

                <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è -->
                <div class="cancel-subscription-section">
                    <p class="cancel-info">–ù–µ —Ö–æ—á–µ—Ç–µ –æ—Ñ–æ—Ä–º–ª—è—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É?</p>
                    <a href="{% url 'subscriptions:pricing' %}" class="btn-cancel-link">
                        –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ –≤–∏–±–æ—Ä—É –ø–ª–∞–Ω—ñ–≤
                    </a>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ - –Ü–Ω—Ñ–æ –ø—Ä–æ –ø–ª–∞–Ω -->
            <aside class="checkout-sidebar">
                <div class="plan-summary">
                    <h3>–û–±—Ä–∞–Ω–∏–π –ø–ª–∞–Ω</h3>

                    <div class="plan-info-box">
                        <div class="plan-header">
                            <div class="plan-icon">
                                {% if 'C-VISION' in plan.name %}
                                <span>üîµ</span>
                                {% elif 'B-VISION' in plan.name %}
                                <span>üèÜ</span>
                                {% elif 'A-VISION' in plan.name %}
                                <span>üéØ</span>
                                {% elif 'PRO-VISION' in plan.name %}
                                <span>üëë</span>
                                {% endif %}
                            </div>
                            <h4>{{ plan.name }}</h4>
                        </div>

                        <div class="plan-price-box">
                            <span class="price-label">–¶—ñ–Ω–∞:</span>
                            <span class="price-value">{{ plan.price }}‚Ç¥</span>
                        </div>

                        <div class="plan-duration">
                            <span class="duration-label">–¢–µ—Ä–º—ñ–Ω:</span>
                            <span class="duration-value">{{ plan.get_duration_display }}</span>
                        </div>

                        {% if plan.savings_percentage > 0 %}
                        <div class="plan-savings">
                            <span class="savings-badge">–ï–∫–æ–Ω–æ–º—ñ—è {{ plan.savings_percentage }}%</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="plan-features-box">
                        <h4>–ü–µ—Ä–µ–≤–∞–≥–∏:</h4>
                        <ul class="features-list">
                            {% for feature in plan.features %}
                            <li>{{ feature }}</li>
                            {% endfor %}
                        </ul>
                    </div>

                    <div class="security-badges">
                        <div class="security-badge">
                            <span class="security-icon">üîí</span>
                            <span class="security-text">–ó–∞—Ö–∏—â–µ–Ω–∏–π –ø–ª–∞—Ç—ñ–∂</span>
                        </div>
                        <div class="security-badge">
                            <span class="security-icon">‚úì</span>
                            <span class="security-text">–ú–∏—Ç—Ç—î–≤–∞ –∞–∫—Ç–∏–≤–∞—Ü—ñ—è</span>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</div>

<!-- Hidden LiqPay Form -->
<div id="liqpay-form-container" style="display: none;"></div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/components/subscription-checkout.js' %}"></script>
<script>
    // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º–∏ –æ–ø–ª–∞—Ç–∏
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('payment-form');
        const validateCouponBtn = document.getElementById('validate-coupon-btn');
        const couponInput = document.getElementById('coupon-code');
        const couponMessage = document.getElementById('coupon-message');
        const payButton = form.querySelector('.btn-pay');

        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø—Ä–æ–º–æ–∫–æ–¥—É
        validateCouponBtn.addEventListener('click', async function () {
            const code = couponInput.value.trim();

            if (!code) {
                showCouponMessage('–í–≤–µ–¥—ñ—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', 'error');
                return;
            }

            validateCouponBtn.disabled = true;
            validateCouponBtn.textContent = '–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...';

            try {
                const response = await fetch('{% url "subscriptions:validate_coupon" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `code=${encodeURIComponent(code)}`
                });

                const data = await response.json();

                if (data.valid) {
                    showCouponMessage(`‚úì –ü—Ä–æ–º–æ–∫–æ–¥ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ! –ó–Ω–∏–∂–∫–∞: ${data.discount}`, 'success');
                    validateCouponBtn.textContent = '‚úì –ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ';
                    validateCouponBtn.classList.add('success');
                } else {
                    showCouponMessage(data.error, 'error');
                    validateCouponBtn.disabled = false;
                    validateCouponBtn.textContent = '–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏';
                }
            } catch (error) {
                showCouponMessage('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥—É', 'error');
                validateCouponBtn.disabled = false;
                validateCouponBtn.textContent = '–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏';
            }
        });

        function showCouponMessage(message, type) {
            couponMessage.textContent = message;
            couponMessage.className = `coupon-message coupon-message-${type}`;
        }

        // –û–±—Ä–æ–±–∫–∞ —Ñ–æ—Ä–º–∏ –æ–ø–ª–∞—Ç–∏
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            payButton.disabled = true;
            payButton.textContent = '–û–±—Ä–æ–±–∫–∞...';

            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ LiqPay —Ñ–æ—Ä–º—É
                    document.getElementById('liqpay-form-container').innerHTML = data.liqpay_html;
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞: ' + data.error);
                    payButton.disabled = false;
                    payButton.textContent = '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –æ–ø–ª–∞—Ç—É {{ plan.price }}‚Ç¥';
                }
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –ø–ª–∞—Ç–µ–∂—É');
                payButton.disabled = false;
                payButton.textContent = '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –æ–ø–ª–∞—Ç—É {{ plan.price }}‚Ç¥';
            }
        });
    });
</script>
{% endblock %}