# Універсальний промпт для запобігання розривів тегів у Django шаблонах

## Проблема

Розриви Django тегів `{{ }}` та `{% %}` на кілька рядків у файлах шаблонів призводять до:
- Небажаних пробілів у згенерованому HTML
- Проблем з форматуванням та відображенням
- Складності читання та підтримки коду

**Приклад проблеми:**
```django
<!-- ❌ Погано - розрив тега -->
{{ loyalty_account.total_points }}/{{ loyalty_account.points_to_next_tier }} балів до {{
loyalty_account.next_tier.name }}

<!-- ✅ Добре - тег в одному рядку -->
{{ loyalty_account.total_points }}/{{ loyalty_account.points_to_next_tier }} балів до {{ loyalty_account.next_tier.name }}
```

---

## Налаштування Django для запобігання розривів

### 1. Django Template Settings

У файлі `settings/base.py` (або відповідному файлі налаштувань) додай наступні опції до `TEMPLATES['OPTIONS']`:

```python
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                # ... твої context processors
            ],
            # ⬇️ ДОДАЙ ЦІ НАЛАШТУВАННЯ ⬇️
            'lstrip_blocks': True,      # Видаляє пробіли на початку блоків {% %}
            'trim_blocks': True,         # Видаляє переноси рядків після блоків {% %}
            'keep_lazy': True,           # Зберігає lazy об'єкти
            'string_if_invalid': '',     # Що показувати при невалідних змінних (порожній рядок)
            'autoescape': True,          # Автоматичний екранізація (безпека)
        },
    },
]
```

**Пояснення налаштувань:**
- `lstrip_blocks: True` - видаляє пробіли на початку рядків з `{% %}` тегами
- `trim_blocks: True` - видаляє переноси рядків після `{% %}` тегів
- Ці налаштування допомагають контролювати whitespace, але **не запобігають розривам тегів на кілька рядків**

### 2. Стиль кодування шаблонів

**Головне правило:** Ніколи не розривай Django теги `{{ }}` та `{% %}` на кілька рядків.

#### ❌ Погано (розрив тега):
```django
<!-- Розрив змінної -->
{{ loyalty_account.total_points }}/{{ loyalty_account.points_to_next_tier }} балів до {{
loyalty_account.next_tier.name }}

<!-- Розрив тега -->
<a href="{% url 'subscriptions:pricing' %}" class="cart-subscription-link">{{
    suggestion_data.message }}</a>

<!-- Розрив умови -->
<button class="btn btn-primary" data-action="mark-completed" {% if progress and material in
    progress.materials_completed.all %}disabled{% endif %}>
```

#### ✅ Добре (тег в одному рядку):
```django
<!-- Змінна в одному рядку -->
{{ loyalty_account.total_points }}/{{ loyalty_account.points_to_next_tier }} балів до {{ loyalty_account.next_tier.name }}

<!-- Тег в одному рядку -->
<a href="{% url 'subscriptions:pricing' %}" class="cart-subscription-link">{{ suggestion_data.message }}</a>

<!-- Умова в одному рядку -->
<button class="btn btn-primary" data-action="mark-completed" {% if progress and material in progress.materials_completed.all %}disabled{% endif %}>
```

#### ✅ Альтернатива (якщо рядок дуже довгий):
```django
<!-- Використовуй окремі змінні або розбивай логічно -->
{% with points=loyalty_account.total_points next_points=loyalty_account.points_to_next_tier tier_name=loyalty_account.next_tier.name %}
    {{ points }}/{{ next_points }} балів до {{ tier_name }}
{% endwith %}

<!-- Або використовуй кастомний фільтр/тег -->
{{ loyalty_account|format_progress_text }}
```

### 3. EditorConfig налаштування

У файлі `.editorconfig` вже є налаштування для HTML:

```ini
# Django HTML шаблони - НЕ форматувати автоматично
[*.html]
indent_style = space
indent_size = 2
# Вимкнути автоформатування для HTML
max_line_length = off
```

**Важливо:** `max_line_length = off` дозволяє довгі рядки, що допомагає уникати розривів тегів.

### 4. Правила форматування шаблонів

#### Для змінних `{{ }}`:
- ✅ Завжди в одному рядку
- ✅ Якщо дуже довго - використовуй `{% with %}` або кастомні фільтри
- ✅ Можна розбивати фільтри на кілька рядків, але не саму змінну:
  ```django
  <!-- ✅ Дозволено -->
  {{ variable|filter1|filter2|filter3
      |filter4|filter5 }}
  
  <!-- ❌ Заборонено -->
  {{ variable
      |filter1 }}
  ```

#### Для тегів `{% %}`:
- ✅ Завжди в одному рядку для простих тегів
- ✅ Для складних умов можна використовувати логічні оператори в одному рядку
- ✅ Для дуже складних умов - використовуй вкладений `{% if %}`:
  ```django
  <!-- ✅ Добре для складних умов -->
  {% if condition1 %}
      {% if condition2 %}
          {% if condition3 %}
              <!-- контент -->
          {% endif %}
      {% endif %}
  {% endif %}
  
  <!-- ❌ Погано - розрив тега -->
  {% if condition1 and condition2 and
      condition3 %}
  ```

#### Для атрибутів HTML:
- ✅ Django теги в атрибутах завжди в одному рядку
- ✅ Якщо атрибут дуже довгий - розбивай HTML атрибути, але не Django тег:
  ```django
  <!-- ✅ Добре -->
  <button 
      class="btn btn-primary" 
      data-action="mark-completed" 
      {% if progress and material in progress.materials_completed.all %}disabled{% endif %}>
  
  <!-- ❌ Погано -->
  <button 
      class="btn btn-primary" 
      data-action="mark-completed" 
      {% if progress and material in
          progress.materials_completed.all %}disabled{% endif %}>
  ```

---

## Універсальний промпт для будь-якого Django проекту

```
Налаштуй Django проект для запобігання розривів тегів {{ }} та {% %} у шаблонах.

### 1. Додай налаштування Django шаблонів

У файлі settings/base.py (або відповідному) додай до TEMPLATES['OPTIONS']:

```python
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                # ... твої context processors
            ],
            'lstrip_blocks': True,      # Видаляє пробіли на початку блоків
            'trim_blocks': True,         # Видаляє переноси після блоків
            'keep_lazy': True,           # Зберігає lazy об'єкти
            'string_if_invalid': '',     # Порожній рядок для невалідних змінних
            'autoescape': True,          # Автоматичний екранізація
        },
    },
]
```

### 2. Налаштуй EditorConfig

Створи або онови файл .editorconfig:

```ini
[*.html]
indent_style = space
indent_size = 2
max_line_length = off  # Дозволяє довгі рядки без розривів тегів
trim_trailing_whitespace = true
```

### 3. Правила кодування шаблонів

**Обов'язкові правила:**
1. Ніколи не розривай Django теги `{{ }}` та `{% %}` на кілька рядків
2. Якщо рядок дуже довгий - використовуй `{% with %}`, кастомні фільтри або вкладені умови
3. HTML атрибути можна розбивати на кілька рядків, але Django теги всередині них - ні
4. Фільтри можна розбивати на кілька рядків, але не саму змінну

**Приклади:**

❌ Погано:
```django
{{ variable
    |filter }}
    
{% if condition1 and
    condition2 %}
```

✅ Добре:
```django
{{ variable|filter }}

{% if condition1 and condition2 %}

{% with var1=value1 var2=value2 %}
    {{ var1 }}/{{ var2 }}
{% endwith %}
```

### 4. Перевірка та тестування

Після налаштування перевір:
1. Всі шаблони на наявність розривів тегів
2. Згенерований HTML не містить небажаних пробілів
3. Форматування працює коректно на всіх сторінках
4. Код читабельний та підтримуваний

### 5. Автоматична перевірка (опціонально)

Можна додати pre-commit hook для перевірки:

```bash
# .pre-commit-config.yaml
repos:
  - repo: local
    hooks:
      - id: check-django-templates
        name: Check Django template tag breaks
        entry: bash -c 'grep -r "{{[^}]*$" templates/ && exit 1 || exit 0'
        language: system
```

Або використовуй djhtml для форматування (але він може не завжди коректно обробляти розриви):
```bash
pip install djhtml
djhtml --check templates/
```

### 6. Додаткові рекомендації

- Використовуй кастомні template tags/filters для складних виразів
- Групуй логіку в `{% with %}` блоки
- Використовуй template includes для повторюваних фрагментів
- Документуй складні шаблони коментарями
- Регулярно перевіряй шаблони на наявність розривів тегів

Застосуй ці налаштування та правила до всього проекту.
```

---

## Знайдені приклади розривів у проекті Play Vision

### Файли з розривами тегів (потрібно виправити):

1. **`templates/account/tabs/subscription.html`** (рядки 21-22):
   ```django
   {{ loyalty_account.total_points }}/{{ loyalty_account.points_to_next_tier }} балів до {{
   loyalty_account.next_tier.name }}
   ```

2. **`templates/cart/cart.html`** (рядки 162-163):
   ```django
   <a href="{% url 'subscriptions:pricing' %}" class="cart-subscription-link">{{
       suggestion_data.message }}</a>
   ```

3. **`templates/hub/material_detail.html`** (рядки 89-90):
   ```django
   <button class="btn btn-primary" data-action="mark-completed" {% if progress and material in
       progress.materials_completed.all %}disabled{% endif %}>
   ```

4. **`templates/hub/course_detail_OLD.html.backup`** (рядки 24-25):
   ```django
   <a href="{% url 'content:course_list' %}?category={{ course.category.slug }}">{{
       course.category.name }}</a>
   ```

### Приклади правильного форматування (як має бути):

1. **`templates/pages/home.html`** (рядки 72-77):
   ```django
   "title": "{{ slide|get_localized_title:country_code|escapejs }}",
   "subtitle": "{{ slide|get_localized_subtitle:country_code|escapejs }}",
   "ctaText": "{{ slide|get_localized_cta_text:country_code|escapejs }}",
   "image": {% if slide.image %}"{{ slide.image.url|escapejs }}"{% else %}null{% endif %},
   ```

2. **`templates/partials/course_card.html`** (рядок 39):
   ```django
   <a href="{{ course.get_absolute_url }}">{{ course.title }}</a>
   ```

---

## Поточний стан налаштувань у проекті

### Django Settings (`playvision/settings/base.py`):
```python
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                # ... context processors
            ],
            # ⚠️ ВІДСУТНІ налаштування lstrip_blocks, trim_blocks
        },
    },
]
```

**Рекомендація:** Додай `lstrip_blocks: True` та `trim_blocks: True` до `OPTIONS`.

### EditorConfig (`.editorconfig`):
```ini
[*.html]
indent_style = space
indent_size = 2
max_line_length = off  # ✅ Вже налаштовано правильно
```

---

## Висновок

Для запобігання розривів тегів у Django шаблонах потрібно:

1. ✅ **Додати Django налаштування:** `lstrip_blocks: True`, `trim_blocks: True`
2. ✅ **Дотримуватися стилю кодування:** ніколи не розривати теги `{{ }}` та `{% %}` на кілька рядків
3. ✅ **Використовувати EditorConfig:** `max_line_length = off` для HTML файлів
4. ✅ **Використовувати альтернативи:** `{% with %}`, кастомні фільтри, вкладені умови для складних випадків
5. ✅ **Регулярно перевіряти:** знаходити та виправляти розриви тегів у шаблонах

Ці налаштування та правила забезпечують чистий, читабельний код без розривів Django тегів.




